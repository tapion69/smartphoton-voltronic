#!/usr/bin/with-contenv bashio
set -e

DATA_DIR="/data/node-red"
FLOWS_FILE="${DATA_DIR}/flows-voltronic.json"
CREDS_FILE="${DATA_DIR}/flows-voltronic_cred.json"
TEMPLATE="/etc/node-red/flows-template.json"

mkdir -p "${DATA_DIR}"

RESET="$(bashio::config 'reset_flows')"

MQTT_HOST="$(bashio::config 'mqtt_host')"
MQTT_PORT="$(bashio::config 'mqtt_port')"
MQTT_USER="$(bashio::config 'mqtt_username')"
MQTT_PASS="$(bashio::config 'mqtt_password')"

[ -z "$MQTT_HOST" ] && MQTT_HOST="core-mosquitto"
[ -z "$MQTT_PORT" ] && MQTT_PORT="1883"

# Toujours écrire le _cred (car config MQTT peut changer)
if [ -n "$MQTT_USER" ] || [ -n "$MQTT_PASS" ]; then
  cat > "$CREDS_FILE" <<EOF
{
  "mqtt_broker_voltronic": { "user": "$MQTT_USER", "password": "$MQTT_PASS" }
}
EOF
else
  echo "{}" > "$CREDS_FILE"
fi

# Génère le flow seulement si absent ou reset
if [ "$RESET" = "true" ] || [ ! -f "$FLOWS_FILE" ]; then
  echo "[voltronic] Writing default Node-RED flow template..."
  cp -f "$TEMPLATE" "$FLOWS_FILE"

  # injecte MQTT host/port + options onduleurs
  sed -i "s#__MQTT_HOST__#${MQTT_HOST}#g" "$FLOWS_FILE"
  sed -i "s#__MQTT_PORT__#${MQTT_PORT}#g" "$FLOWS_FILE"

  INV1_PORT="$(bashio::config 'inverters[0].port')"
  INV1_BAUD="$(bashio::config 'inverters[0].baudrate')"
  INV1_EN="$(bashio::config 'inverters[0].enabled')"

  INV2_PORT="$(bashio::config 'inverters[1].port')"
  INV2_BAUD="$(bashio::config 'inverters[1].baudrate')"
  INV2_EN="$(bashio::config 'inverters[1].enabled')"

  INV3_PORT="$(bashio::config 'inverters[2].port')"
  INV3_BAUD="$(bashio::config 'inverters[2].baudrate')"
  INV3_EN="$(bashio::config 'inverters[2].enabled')"

  POLL="$(bashio::config 'poll_interval_s')"
  [ -z "$POLL" ] && POLL="5"

  sed -i "s#__INV1_PORT__#${INV1_PORT}#g" "$FLOWS_FILE"
  sed -i "s#__INV1_BAUD__#${INV1_BAUD}#g" "$FLOWS_FILE"
  sed -i "s#__INV1_EN__#${INV1_EN}#g" "$FLOWS_FILE"

  sed -i "s#__INV2_PORT__#${INV2_PORT}#g" "$FLOWS_FILE"
  sed -i "s#__INV2_BAUD__#${INV2_BAUD}#g" "$FLOWS_FILE"
  sed -i "s#__INV2_EN__#${INV2_EN}#g" "$FLOWS_FILE"

  sed -i "s#__INV3_PORT__#${INV3_PORT}#g" "$FLOWS_FILE"
  sed -i "s#__INV3_BAUD__#${INV3_BAUD}#g" "$FLOWS_FILE"
  sed -i "s#__INV3_EN__#${INV3_EN}#g" "$FLOWS_FILE"

  sed -i "s#__POLL_S__#${POLL}#g" "$FLOWS_FILE"
else
  echo "[voltronic] Keeping existing flows (so your edits stay)."
fi

chmod 644 "$FLOWS_FILE" "$CREDS_FILE" || true
