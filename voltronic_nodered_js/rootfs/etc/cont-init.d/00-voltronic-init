#!/usr/bin/with-contenv bash
set -e

FLOW_DIR="/data/node-red"
TEMPLATE="/etc/node-red/flows-template.json"
FLOW_OUT="${FLOW_DIR}/flows-voltronic.json"
CRED_OUT="${FLOW_DIR}/flows-voltronic_cred.json"

echo "[voltronic] Preparing Node-RED flow/credentials..."

mkdir -p "${FLOW_DIR}"

MQTT_HOST="$(node -p "require('/data/options.json').mqtt_host || 'core-mosquitto'")"
MQTT_PORT="$(node -p "String(require('/data/options.json').mqtt_port || 1883)")"
MQTT_USER="$(node -p "String(require('/data/options.json').mqtt_username || '')")"
MQTT_PASS="$(node -p "String(require('/data/options.json').mqtt_password || '')")"

echo "[voltronic] MQTT host=${MQTT_HOST} port=${MQTT_PORT} user=${MQTT_USER:+(set)} pass=${MQTT_PASS:+(set)}"

# Flow (host/port)
cp -f "${TEMPLATE}" "${FLOW_OUT}"
sed -i "s#__MQTT_HOST__#${MQTT_HOST}#g" "${FLOW_OUT}"
sed -i "s#__MQTT_PORT__#${MQTT_PORT}#g" "${FLOW_OUT}"

# Credentials (user/pass)
cat > "${CRED_OUT}" <<EOF
{
  "mqtt_broker_voltronic": {
    "user": "${MQTT_USER}",
    "password": "${MQTT_PASS}"
  }
}
EOF

echo "[voltronic] Wrote:"
echo " - ${FLOW_OUT}"
echo " - ${CRED_OUT}"

echo "[voltronic] Debug listing:"
ls -la "${FLOW_DIR}" || true
