#!/usr/bin/with-contenv bashio
set -e

DATA_DIR="/data/node-red"
FLOWS_FILE="${DATA_DIR}/flows-voltronic.json"
CREDS_FILE="${DATA_DIR}/flows-voltronic_cred.json"

mkdir -p "${DATA_DIR}"

RESET="$(bashio::config 'reset_flows')"

MQTT_HOST="$(bashio::config 'mqtt_host')"
MQTT_PORT="$(bashio::config 'mqtt_port')"
MQTT_USER="$(bashio::config 'mqtt_username')"
MQTT_PASS="$(bashio::config 'mqtt_password')"

[ -z "$MQTT_HOST" ] && MQTT_HOST="core-mosquitto"
[ -z "$MQTT_PORT" ] && MQTT_PORT="1883"

echo "[voltronic] MQTT → ${MQTT_HOST}:${MQTT_PORT} (user: ${MQTT_USER:-none})"
echo "[voltronic] reset_flows=${RESET}"

# Créer creds (toujours, car config peut changer)
if [ -n "$MQTT_USER" ] || [ -n "$MQTT_PASS" ]; then
  cat > "$CREDS_FILE" <<EOF
{
  "mqtt_broker_voltronic": {
    "user": "$MQTT_USER",
    "password": "$MQTT_PASS"
  }
}
EOF
else
  echo "{}" > "$CREDS_FILE"
fi

# Générer flow UNIQUEMENT si absent ou reset_flows=true
if [ "$RESET" = "true" ] || [ ! -f "$FLOWS_FILE" ]; then
  echo "[voltronic] Writing default flow (full nodes)..."

  cat > "$FLOWS_FILE" <<EOF
[
  { "id":"tab_voltronic","type":"tab","label":"Voltronic","disabled":false,"info":"Auto flow" },

  {
    "id":"mqtt_broker_voltronic","type":"mqtt-broker","name":"MQTT (auto)",
    "broker":"$MQTT_HOST","port":"$MQTT_PORT","clientid":"nodered-voltronic",
    "autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60",
    "cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"",
    "closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0",
    "willPayload":"","sessionExpiry":""
  },

  {
    "id":"mqtt_in_state","type":"mqtt in","z":"tab_voltronic","name":"voltronic/+/state",
    "topic":"voltronic/+/state","qos":"0","datatype":"auto","broker":"mqtt_broker_voltronic",
    "nl":false,"rap":true,"rh":0,"inputs":0,"x":170,"y":120,"wires":[["json_parse"]]
  },

  { "id":"json_parse","type":"json","z":"tab_voltronic","name":"Parse JSON","property":"payload","action":"","pretty":false,"x":360,"y":120,"wires":[["ha_discovery_fn"]] },

  {
    "id":"ha_discovery_fn",
    "type":"function",
    "z":"tab_voltronic",
    "name":"MQTT Discovery + States",
    "func":"const data = msg.payload;\\nconst inv = data.inverter || 'inv';\\nconst sensors = [\\n  { key:'grid_v', name:'Grid Voltage', unit:'V', device_class:'voltage' },\\n  { key:'battery_v', name:'Battery Voltage', unit:'V', device_class:'voltage' },\\n  { key:'pv_w_est', name:'PV Power', unit:'W', device_class:'power' },\\n  { key:'load_pct', name:'Load', unit:'%', device_class:null }\\n];\\n\\nconst out=[];\\nfor (const s of sensors){\\n  if (data[s.key] == null) continue;\\n  const base = `homeassistant/sensor/voltronic_${inv}_${s.key}`;\\n  out.push({ topic:`${base}/config`, payload: JSON.stringify({\\n    name:`Voltronic ${inv} ${s.name}`,\\n    state_topic:`${base}/state`,\\n    unit_of_measurement:s.unit,\\n    device_class:s.device_class || undefined,\\n    unique_id:`voltronic_${inv}_${s.key}`,\\n    device:{ identifiers:[`voltronic_${inv}`], name:`Voltronic ${inv}`, manufacturer:'Voltronic', model:'Inverter' }\\n  }), retain:true });\\n  out.push({ topic:`${base}/state`, payload:String(data[s.key]), retain:false });\\n}\\nreturn [out];",
    "outputs":1,
    "noerr":0,
    "initialize":"",
    "finalize":"",
    "libs":[],
    "x":590,
    "y":120,
    "wires":[["mqtt_out_any"]]
  },

  {
    "id":"mqtt_out_any",
    "type":"mqtt out",
    "z":"tab_voltronic",
    "name":"MQTT OUT",
    "topic":"",
    "qos":"",
    "retain":"",
    "broker":"mqtt_broker_voltronic",
    "x":800,
    "y":120,
    "wires":[]
  }
]
EOF
else
  echo "[voltronic] Keeping existing flow (so your edits stay)."
fi

chmod 644 "$FLOWS_FILE" "$CREDS_FILE" || true

echo "[voltronic] Files:"
ls -la "$DATA_DIR" || true
