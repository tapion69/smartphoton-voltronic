#!/usr/bin/with-contenv bash
set -e

FLOW_DIR="/data/node-red"
TEMPLATE="/etc/node-red/flows-template.json"
FLOW_OUT="${FLOW_DIR}/flows-voltronic.json"
CRED_OUT="${FLOW_DIR}/flows-voltronic_cred.json"

mkdir -p "${FLOW_DIR}"

MQTT_HOST="$(node -p "require('/data/options.json').mqtt_host || 'core-mosquitto'")"
MQTT_PORT="$(node -p "String(require('/data/options.json').mqtt_port || 1883)")"
MQTT_USER="$(node -p "String(require('/data/options.json').mqtt_username || '')")"
MQTT_PASS="$(node -p "String(require('/data/options.json').mqtt_password || '')")"

echo "[voltronic] Generating Node-RED flow with MQTT=${MQTT_HOST}:${MQTT_PORT}"

# Génère flows-voltronic.json (host/port)
cp -f "${TEMPLATE}" "${FLOW_OUT}"
sed -i "s#__MQTT_HOST__#${MQTT_HOST}#g" "${FLOW_OUT}"
sed -i "s#__MQTT_PORT__#${MQTT_PORT}#g" "${FLOW_OUT}"

# Génère flows-voltronic_cred.json (user/pass)
cat > "${CRED_OUT}" <<EOF
{
  "mqtt_broker_voltronic": {
    "user": "${MQTT_USER}",
    "password": "${MQTT_PASS}"
  }
}
EOF

echo "[voltronic] Flow + credentials generated:"
echo " - ${FLOW_OUT}"
echo " - ${CRED_OUT}"
