#!/usr/bin/with-contenv bash
set -e

CONFIG="/data/options.json"
FLOW_DIR="/data/node-red"
FLOW_TEMPLATE="/etc/node-red/flows-template.json"
FLOW_OUT="${FLOW_DIR}/flows-voltronic.json"
CRED_OUT="${FLOW_DIR}/flows-voltronic_cred.json"

echo "[voltronic] Installing default Node-RED flows..."

mkdir -p "${FLOW_DIR}"

# Lire config HA
MQTT_HOST=$(jq -r '.mqtt_host' "$CONFIG")
MQTT_PORT=$(jq -r '.mqtt_port' "$CONFIG")
MQTT_USER=$(jq -r '.mqtt_username // empty' "$CONFIG")
MQTT_PASS=$(jq -r '.mqtt_password // empty' "$CONFIG")

# 1️⃣ Générer le flow
sed \
  -e "s#__MQTT_HOST__#${MQTT_HOST}#g" \
  -e "s#__MQTT_PORT__#${MQTT_PORT}#g" \
  "${FLOW_TEMPLATE}" > "${FLOW_OUT}"

# 2️⃣ Générer les credentials
cat > "${CRED_OUT}" <<EOF
{
  "mqtt_broker_voltronic": {
    "user": "${MQTT_USER}",
    "password": "${MQTT_PASS}"
  }
}
EOF

echo "[voltronic] Node-RED flows ready"
