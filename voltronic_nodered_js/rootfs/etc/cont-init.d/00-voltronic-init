#!/usr/bin/with-contenv bashio
set -e

echo "[voltronic] Installing default Node-RED flows..."

DATA_DIR="/data/node-red"
FLOWS_FILE="$DATA_DIR/flows-voltronic.json"
CREDS_FILE="$DATA_DIR/flows-voltronic_cred.json"

mkdir -p "$DATA_DIR"

# =========================
# Récupération config add-on
# =========================
MQTT_HOST="$(bashio::config 'mqtt_host')"
MQTT_PORT="$(bashio::config 'mqtt_port')"
MQTT_USER="$(bashio::config 'mqtt_username')"
MQTT_PASS="$(bashio::config 'mqtt_password')"

# Valeurs par défaut
[ -z "$MQTT_HOST" ] && MQTT_HOST="core-mosquitto"
[ -z "$MQTT_PORT" ] && MQTT_PORT="1883"

echo "[voltronic] MQTT → $MQTT_HOST:$MQTT_PORT (user: ${MQTT_USER:-none})"

# =========================
# FLOW PRINCIPAL
# =========================
if [ ! -f "$FLOWS_FILE" ]; then
  cat > "$FLOWS_FILE" <<EOF
[
  {
    "id": "mqtt_broker_voltronic",
    "type": "mqtt-broker",
    "name": "MQTT (auto)",
    "broker": "$MQTT_HOST",
    "port": "$MQTT_PORT",
    "clientid": "nodered-voltronic",
    "autoConnect": true,
    "usetls": false,
    "protocolVersion": "4",
    "keepalive": "60",
    "cleansession": true,
    "birthTopic": "",
    "birthQos": "0",
    "birthPayload": "",
    "closeTopic": "",
    "closeQos": "0",
    "closePayload": "",
    "willTopic": "",
    "willQos": "0",
    "willPayload": "",
    "sessionExpiry": ""
  }
]
EOF
  echo "[voltronic] Created flows-voltronic.json"
fi

# =========================
# FICHIER CREDENTIALS MQTT
# =========================
cat > "$CREDS_FILE" <<EOF
{
  "mqtt_broker_voltronic": {
    "user": "$MQTT_USER",
    "password": "$MQTT_PASS"
  }
}
EOF

echo "[voltronic] Wrote MQTT credentials"

# Permissions propres
chown -R node-red:node-red "$DATA_DIR" || true

echo "[voltronic] Init complete"
ls -la "$DATA_DIR"
